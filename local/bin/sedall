#!/bin/sh

# constants

COMMAND_NAME=$(basename $0)


# functions

message() {
  echo "$@" >&2
}

fail() {
  message "$@"
  exit 1
}

check_args() {
  [ $# -ne 1 ] &&
  fail "usage: $COMMAND_NAME [-d DIR] S_COMMAND"
}

is_valid_file() {
  [ $# -ne 1 ] &&
  fail "usage: $0 FILE"

  local file=$1

  [ -r "$file" ] &&
  [ -w "$file" ] &&
  [ -n "$(file "$file" | grep text)" ] &&
  [ -z "$(echo "$file" | grep -e '/\.' -e '^\.[^/]')" ]
}

sed_file() {
  [ $# -ne 2 ] &&
  fail "usage: $0 S_COMMAND FILE"

  local s_command=$1
  local file=$2

  local tmp_file=$file.$COMMAND_NAME.tmp
  sed "$s_command" "$file" > "$tmp_file"
  mv "$tmp_file" "$file"
}


# main routine

main() {
  check_args "$@"
  local s_command=$1

  for file in $(find . -type f)
  do
    if is_valid_file "$file"
    then
      sed_file "$s_command" "$file"
    fi
  done
}

main "$@"
