#!/bin/sh

# constants

COMMAND_NAME=$(basename $0)


# functions

message() {
  echo "$@" >&2
}

fail() {
  message "$@"
  exit 1
}

check_args() {
  [ $# -ne 1 ] &&
  fail "usage: $COMMAND_NAME SED_COMMAND"
}

is_valid_file() {
  [ $# -ne 1 ] &&
  fail "usage: $0 FILE"

  local file=$1

  [ -r "$file" ] &&
  [ -w "$file" ] &&
  [ -n "$(file "$file" | grep text)" ] &&
  [ -z "$(echo "$file" | grep -e '/\.' -e '^\.[^/]')" ]
}

gnu_sed() {
  if which gsed > /dev/null 2>&1
  then
    gsed "$@"
  else
    sed "$@"
  fi
}


# main routine

main() {
  check_args "$@"
  local s_command="$1"

  for file in $(find . -type f)
  do
    if is_valid_file "$file"
    then
      gnu_sed -i "$s_command" "$file"
    fi &
  done

  wait
}

main "$@"
