#!/bin/sh

is_valid_file() {
  [ -r "$1" ] &&
  [ -w "$1" ] &&
  [ -n "$(file "$1" | grep text)" ] &&
  [ -z "$(echo "$1" | grep -e '/\.' -e '^\.[^/]')" ]
}

filter() {
  while read -r line
  do
    if is_valid_file "$line"
    then
      echo "$line"
    fi
  done | grep -v '^[[:blank:]]*$'
}

if [ $# -ne 1 ]
then
  echo "usage: $(basename $0) <command>" >&2
  exit 1
fi &&

find . -type f | filter | xargs -n 128 sed -i "$1"
